define("metaphorjs-history",["metaphorjs-observable"],function(O){function w(){return!1}function x(){return!0}function y(a){return"object"==typeof a&&3===P(a)&&!a.nodeType&&a.constructor===Object}function C(a){return!0===a||!1===a}function F(a,b,c,e){return setTimeout(function(){a.apply(b,c||[])},e||0)}function Q(){}var t=Array.prototype.slice,R=Object.prototype.toString,P=function(){var a={"[object String]":0,"[object Number]":1,"[object Boolean]":2,"[object Object]":3,"[object Function]":4,"[object Array]":5,
"[object RegExp]":9,"[object Date]":10};return function(b){if(!b){if(null===b)return 6;if(void 0===b)return 7}var c=a[R.call(b)];return void 0===c?-1:1===c&&isNaN(b)?8:c}}(),p=function(){return function b(){var c=!1,e=!1,g=t.call(arguments),f=g.shift(),d,n,h;C(g[g.length-1])&&(c=g.pop());C(g[g.length-1])&&(e=c,c=g.pop());for(;g.length;)if((d=g.shift())&&d.hasOwnProperty)for(n in d)if(d.hasOwnProperty(n)&&void 0!==(h=d[n]))if(e)if(f[n]&&y(f[n])&&y(h))b(f[n],h,c,e);else{if(!0===c||void 0==f[n])y(h)?
(f[n]={},b(f[n],h,c,!0)):f[n]=h}else if(!0===c||void 0==f[n])f[n]=h;return f}}(),B=function(a){if(a instanceof B)return a;if(!(this instanceof B))return new B(a);for(var b in a)if(!this[b])try{this[b]=a[b]}catch(g){}this.originalEvent=a;this.type=a.type;!this.target&&a.srcElement&&(this.target=a.srcElement);var c=a.button;if(void 0===this.pageX&&null!==a.clientX){var e=this.target?this.target.ownerDocument||window.document:window.document;b=e.documentElement;e=e.body;this.pageX=a.clientX+(b&&b.scrollLeft||
e&&e.scrollLeft||0)-(b&&b.clientLeft||e&&e.clientLeft||0);this.pageY=a.clientY+(b&&b.scrollTop||e&&e.scrollTop||0)-(b&&b.clientTop||e&&e.clientTop||0)}this.which||void 0===c||(this.which=c&1?1:c&2?3:c&4?2:0);this.isDefaultPrevented=a.defaultPrevented||void 0===a.defaultPrevented&&!1===a.returnValue?x:w;this.timeStamp=a&&a.timeStamp||(new Date).getTime()};p(B.prototype,{isDefaultPrevented:w,isPropagationStopped:w,isImmediatePropagationStopped:w,preventDefault:function(){var a=this.originalEvent;this.isDefaultPrevented=
x;a.returnValue=!1;a&&a.preventDefault&&a.preventDefault()},stopPropagation:function(){var a=this.originalEvent;this.isPropagationStopped=x;a.cancelBubble=!0;a&&a.stopPropagation&&a.stopPropagation()},stopImmediatePropagation:function(){var a=this.originalEvent;this.isImmediatePropagationStopped=x;a&&a.stopImmediatePropagation&&a.stopImmediatePropagation();this.stopPropagation()}},!0,!1);var M=function(a){function b(){e=null}var c,e;a=function(a){return function(f){var d=new B(f||window.event),g=
t.call(arguments,1),h=0,l=0,k=0,m=0;d.type="mousewheel";"detail"in d&&(l=-1*d.detail);"wheelDelta"in d&&(l=d.wheelDelta);"wheelDeltaY"in d&&(l=d.wheelDeltaY);"wheelDeltaX"in d&&(h=-1*d.wheelDeltaX);"axis"in d&&d.axis===d.HORIZONTAL_AXIS&&(h=-1*l,l=0);var q=0===l?h:l;"deltaY"in d&&(q=l=-1*d.deltaY);"deltaX"in d&&(h=d.deltaX,0===l&&(q=-1*h));if(0!==l||0!==h){var r=Math.max(Math.abs(l),Math.abs(h));if(!e||r<e)e=r,"mousewheel"===d.type&&0===r%120&&(e/=40);"mousewheel"===d.type&&0===r%120&&(q/=40,h/=40,
l/=40);q=Math[1<=q?"floor":"ceil"](q/e);h=Math[1<=h?"floor":"ceil"](h/e);l=Math[1<=l?"floor":"ceil"](l/e);this.getBoundingClientRect&&(r=this.getBoundingClientRect(),k=d.clientX-r.left,m=d.clientY-r.top);d.deltaX=h;d.deltaY=l;d.deltaFactor=e;d.offsetX=k;d.offsetY=m;d.deltaMode=0;g.unshift(d,q,h,l);c&&clearTimeout(c);c=setTimeout(b,200);return a.apply(this,g)}}};a.events=function(){var a=window.document;return"onwheel"in a||9<=a.documentMode?["wheel"]:["mousewheel","DomMouseScroll","MozMousePixelScroll"]};
return a}(),D=function(){var a=null,b=null;return function(c,e,g){null===a&&(c.addEventListener?(a="addEventListener",b=""):(a="attachEvent",b="on"));if("mousewheel"==e){g=M(g);e=M.events();var f;var d=0;for(f=e.length;d<f;d++)c[a](b+e[d],g,!1)}else c[a](b+e,g,!1);return g}}(),G=function(){var a=["0","0","0"];return function(){for(var b=a.length,c;b;){b--;c=a[b].charCodeAt(0);if(57==c)return a[b]="A",a.join("");if(90==c)a[b]="0";else return a[b]=String.fromCharCode(c+1),a.join("")}a.unshift("0");
return a.join("")}}();p(function(a,b){this.name=a;this.listeners=[];this.map={};this.hash=G();this.uni="$$"+a+"_"+this.hash;this.suspended=!1;this.lid=0;"object"===typeof b&&null!==b?p(this,b,!0,!1):this.returnResult=b}.prototype,{name:null,listeners:null,map:null,hash:null,uni:null,suspended:!1,lid:null,returnResult:null,autoTrigger:null,lastTrigger:null,triggerFilter:null,filterContext:null,expectPromises:!1,resolvePromises:!1,getName:function(){return this.name},destroy:function(){for(var a in this)this[a]=
null},on:function(a,b,c){if(!a)return null;b=b||null;c=c||{};var e=this.uni,g=a||b;if(g[e]&&!c.allowDupes)return null;var f=++this.lid,d=c.first||!1;g[e]=f;a={fn:a,context:b,uniContext:g,id:f,async:!1,called:0,limit:0,start:1,count:0,append:null,prepend:null};p(a,c,!0,!1);!0===a.async&&(a.async=1);d?this.listeners.unshift(a):this.listeners.push(a);this.map[f]=a;if(this.autoTrigger&&this.lastTrigger&&!this.suspended){var n=this.triggerFilter;this.triggerFilter=function(a){return a.id===f?n?!1!==n(a):
!0:!1};this.trigger.apply(this,this.lastTrigger);this.triggerFilter=n}return f},once:function(a,b,c){c=c||{};c.limit=1;return this.on(a,b,c)},un:function(a,b){var c=-1,e=this.uni,g=this.listeners;a=a==parseInt(a)?parseInt(a):(b||a)[e];if(!a)return!1;b=0;for(var f=g.length;b<f;b++)if(g[b].id===a){c=b;delete g[b].uniContext[e];break}if(-1===c)return!1;g.splice(c,1);delete this.map[a];return!0},hasListener:function(a,b){var c=this.listeners;if(a){b=b||a;a="function"!=typeof a?parseInt(a):b[this.uni];
if(!a)return!1;b=0;for(var e=c.length;b<e;b++)if(c[b].id===a)return!0;return!1}return 0<c.length},removeAllListeners:function(){var a=this.listeners,b=this.uni,c;var e=0;for(c=a.length;e<c;e++)delete a[e].uniContext[b];this.listeners=[];this.map={}},suspend:function(){this.suspended=!0},resume:function(){this.suspended=!1},_prepareArgs:function(a,b){if(a.append||a.prepend)b=t.call(b),a.prepend&&(b=a.prepend.concat(b)),a.append&&(b=b.concat(a.append));return b},trigger:function(){var a=this,b=a.listeners,
c=a.returnResult,e=a.triggerFilter,g=a.filterContext,f=a.expectPromises,d=[],n;if(a.suspended)return null;a.autoTrigger&&(a.lastTrigger=t.call(arguments));if(0===b.length)return null;var h="all"===c||"concat"===c?[]:"merge"===c?{}:null,l,k;for(l="first"===c?[b[0]]:t.call(b);k=l.shift();)if(!(!k||!a.map[k.id]||(b=a._prepareArgs(k,arguments),e&&!1===e.call(g,k,b,a))||k.filter&&!1===k.filter.apply(k.filterContext||k.context,b)||(k.count++,k.count<k.start))){if(k.async&&!f){var m=null;F(k.fn,k.context,
b,k.async)}else f?(m=function(b,c,e){return function(d){"pipe"===c&&(e[0]=d,e=a._prepareArgs(b,e));return b.fn.apply(b.context,e)}}(k,c,t.call(arguments)),m=n?n.then(m):k.fn.apply(k.context,b),m.catch(function(a){console.log(a)})):m=k.fn.apply(k.context,b);k.called++;k.called===k.limit&&a.un(k.id);if("first"===c)return m;if(f)d.push(m),"pipe"===c&&m&&(n=m);else if(null!==c)if("all"===c)h.push(m);else if("concat"===c&&m)h=h.concat(m);else if("merge"===c)p(h,m,!0,!1);else{if("nonempty"===c&&m)return m;
if("pipe"===c)h=m,arguments[0]=m;else if("last"===c)h=m;else{if(!1===c&&!1===m)return!1;if(!0===c&&!0===m)return!0}}}return f?(e=Promise.all(d),a.resolvePromises&&null!==c&&"all"!==c&&(e=e.then(function(a){var b,e=a.length;for(b=0;b<e;b++){var d=a[b];if("concat"===c&&d)h=h.concat(d);else if("merge"===c)p(h,d,!0,!1);else{if("nonempty"===c&&d)return d;if(!1===c&&!1===d)return!1;if(!0===c&&!0===d)return!0}}return h})),e):h}},!0,!1);var S=/^(((([^:\/#\?]+:)?(?:(\/\/)((?:(([^:@\/#\?]+)(?::([^:@\/#\?]+))?)@)?(([^:\/#\?\]\[]+|\[[^\/\]@#?]+\])(?::([0-9]+))?))?)?)?((\/?(?:[^\/\?#]+\/+)*)([^\?#]*)))?(\?[^#]+)?)(#.*)?/,
u=function(a){var b=a.match(S)||[],c=("undefined"!=typeof window?window.location:null)||{};return{protocol:b[4]||c.protocol||"http:",hostname:b[11]||c.hostname||"",host:(b[11]||"")+(b[12]?":"+b[12]:"")||c.host||"",username:b[8]||c.username||"",password:b[9]||c.password||"",port:parseInt(b[12],10)||c.port||"",href:a,path:(b[13]||"/")+(b[16]||""),pathname:b[13]||"/",search:b[16]||"",hash:b[17]&&"#"!=b[17]?b[17]:""}},H=function(a,b){var c="";b=b||{};b.onlyPath||(c+=a.protocol+"//",a.username&&a.password&&
(c+=a.username+":"+a.password+"@"),c+=a.hostname,a.hostname&&a.port&&(c+=":"+a.port));b.onlyHost||(c+=a.pathname||"/",a.search&&"?"!=a.search&&(c+=a.search),a.hash&&"#"!=a.hash&&(c+=a.hash));return c};return function(){var a,b,c,e=new O,g=G(),f="$$"+g,d=G(),n=new RegExp("#"+g+"=([A-Z0-9]+)"),h,l,k="undefined"==typeof window,m=null,q,r,t;e.createEvent("before-location-change",!1);e.createEvent("void-click",!1);var w=function(a){a=a||{};a[f]||(a[f]=G());d=a[f];return a},x=function(a){a=a||{};a[f]||
(a[f]=d);return a},y=function(a,b){"string"==typeof a&&(a=u(a));"string"==typeof b&&(b=u(b));var c=["protocol","host","port"],N;var e=0;for(N=c.length;e<N;e++){var d=c[e];if(a[d]&&b[d]&&a[d]!=b[d])return!0}return!1},I=function(a,b){"string"==typeof a&&(a=u(a));"string"==typeof b&&(b=u(b));return y(a,b)||a.pathname!=b.pathname||a.search!=b.search||a.hash!=b.hash},z=function(a){a=u(a);return!q||t?a.path:H(a,{onlyPath:!0})},J=function(a){var b=null;a=a.replace(n,function(a,c){b=c;return""});return{hash:a,
id:b}},K=function(a,b){a?("#"!=a.substr(0,1)&&(a=J(a).hash,a="!"+a+"#"+g+"="+d),c.hash=a):c.hash=""},E=function(){if(q)var a=H(c);else{a=c.hash.substr(1);var b=p({},c,!0,!1);a&&(a=J(a).hash,"!"==a.substr(0,1)&&(a=a.substr(1)),a=decodeURIComponent(a).split("?"),b.pathname=a[0],b.search=a[1]?"?"+a[1]:"");a=H(b)}return a},C=function(a){m=p({},c,!0,!1);v("location-change",a)},L=function(){if(I(m,c)){var a=E();v("before-location-pop",a);d=q?b.state?b.state[f]:null:J(c.hash).id;m=p({},c,!0,!1);v("location-change",
a)}},v=function(a,b,c){b=b||E();var d=u(b);return e.trigger(a,d.pathname+d.search+d.hash,c,b)},A=function(){a=window;b=a.history;c=a.location;q=!!b.pushState;r="onhashchange"in a;t=!1;m=p({},c,!0,!1);if(q)D(a,"popstate",L),h=function(a,c,d){if(!1===v("before-location-change",a,c))return!1;b.pushState(w(d),null,z(a));C(a)},l=function(a,c,d){b.replaceState(x(d),null,z(a));C(a)},l(E());else if(r)h=function(a,b,c){if(!1===v("before-location-change",a,b))return!1;F(K,null,[z(a),w(c)])},l=function(a,b,
c){F(K,null,[z(a),x(c)])},D(a,"hashchange",L);else{var d=null,f=!1;a.onIframeHistoryChange=function(a){f||F(function(){K(a);L()})};var g=function(a){var b=d.contentDocument?d.contentDocument:d.contentWindow.document;b.open();b.write("<html><head><title>"+document.title+'</title><script type="text/javascript">var hashValue = "'+a+'";window.top.onIframeHistoryChange(hashValue);\x3c/script></head><body>&nbsp;</body></html>');b.close()};h=function(a,b,c){if(!1===v("before-location-change",a,b))return!1;
g(z(a))};l=function(a,b,c){if(!1===v("before-location-change",a,b))return!1;d.contentWindow.hashValue=z(a)};var n=function(){d=window.document.createElement("iframe");d.src="about:blank";d.style.display="none";window.document.body.appendChild(d);f=!0;g(z(c.hash.substr(1)));f=!1};k?n():D(a,"load",n)}D(window.document.documentElement,"click",function(b){b=new B(b||a.event);for(var d=b.target,f;d&&"a"!=d.nodeName.toLowerCase();)d=d.parentNode;if(d&&!b.isDefaultPrevented()){f=d.getAttribute?d.getAttribute("href"):
null;if("#"==f&&!e.trigger("void-click",d))return b.preventDefault(),b.stopPropagation(),!1;if(f&&"#"!=f.substr(0,1)&&(!d.getAttribute||!d.getAttribute("target"))){var g=p({},c,!0,!1),k=u(f);if(y(g,k))return null;I(g,k)?h(f,d):v("same-location",null,d);b.preventDefault();b.stopPropagation();return!1}}return null});A=Q};D(window,"load",function(){k=!0});return p({},e.getApi(),{push:function(a,b){A();var d=p({},c,!0,!1),e=u(a);if(y(d,e))return null;I(d,e)&&h(a,null,b)},replace:function(a,b){A();l(a,
null,b)},saveState:function(a){A();l(E(),null,a)},mergeState:function(a){this.saveState(p({},b.state,a,!0,!1))},getState:function(){return b.state},getCurrentStateId:function(){return d},current:function(){A();return E()},init:function(){return A()},polyfill:function(){A();window.history.pushState=function(a,b,c){h(c,null,a)};window.history.replaceState=function(a,b,c){l(c,null,a)}}})}()});
